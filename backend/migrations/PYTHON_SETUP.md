# Запуск миграций через Python

## Требования

Необходимо установить зависимости:

```bash
pip install psycopg2-binary python-dotenv
```

## Настройка подключения к БД

Создайте файл `.env` в корне проекта (скопируйте из `.env.example`):

```bash
cp .env.example .env
```

Отредактируйте параметры подключения к PostgreSQL в `.env`:

```ini
# Для локальной PostgreSQL (не в Docker)
DB_HOST=localhost
DB_PORT=5432
DB_NAME=bazarlar_claude
DB_USER=bazarlar_user
DB_PASSWORD=bazarlar_pass
```

**Важно:** Если PostgreSQL запущен в Docker, но вы запускаете скрипт на хосте:
- `DB_HOST=localhost` (не `postgres`)
- Порт должен быть проброшен в docker-compose.yml

## Запуск миграций

### Вариант 1: Все миграции сразу

```bash
python backend/migrations/run_migrations.py
```

Это выполнит по очереди:
1. `001_create_tables.sql` - создание всех таблиц
2. `002_reference_data.sql` - загрузка справочных данных (города, рынки, категории)
3. `003_test_data.sql` - загрузка тестовых данных

### Вариант 2: Только структура БД

```bash
python backend/migrations/run_migrations.py --schema-only
```

Выполнит только `001_create_tables.sql`

### Вариант 3: Только данные (без структуры)

```bash
python backend/migrations/run_migrations.py --data-only
```

Выполнит `002_reference_data.sql` и `003_test_data.sql`

### Вариант 4: Только тестовые данные

```bash
python backend/migrations/run_migrations.py --test-data-only
```

Выполнит только `003_test_data.sql`

## Создание базы данных

Если база данных еще не создана, выполните:

```bash
# Подключитесь к PostgreSQL
psql -U postgres

# Создайте пользователя и базу данных
CREATE USER bazarlar_user WITH PASSWORD 'bazarlar_pass';
CREATE DATABASE bazarlar_claude OWNER bazarlar_user;
\q
```

## Пример вывода

```
============================================================
ЗАПУСК МИГРАЦИЙ БАЗЫ ДАННЫХ
============================================================
Подключение к bazarlar_user@localhost:5432/bazarlar_claude

============================================================
Выполнение: 001_create_tables.sql
============================================================
✅ 001_create_tables.sql выполнен успешно

============================================================
Выполнение: 002_reference_data.sql
============================================================

========================================
СПРАВОЧНЫЕ ДАННЫЕ ЗАГРУЖЕНЫ УСПЕШНО!
========================================
Городов: 15
Рынков: 10
Категорий: 87
========================================

✅ 002_reference_data.sql выполнен успешно

============================================================
Выполнение: 003_test_data.sql
============================================================

========================================
ТЕСТОВЫЕ ДАННЫЕ УСПЕШНО СОЗДАНЫ!
========================================
Пользователей всего: 14
Продавцов товаров: 5
Продавцов услуг: 4
Покупателей: 5

Товаров: 30
Услуг: 8

Заказов товаров: 20
Записей на услуги: 10
Отзывов: 25
========================================

✅ 003_test_data.sql выполнен успешно

============================================================
ИТОГИ
============================================================
Успешно выполнено: 3
Ошибок: 0
============================================================
```

## Устранение проблем

### Ошибка подключения

Если получаете ошибку `could not connect to server`:
- Убедитесь, что PostgreSQL запущен: `sudo systemctl status postgresql`
- Проверьте параметры в `.env`
- Проверьте, что порт проброшен (если используете Docker)

### Ошибка "database does not exist"

Создайте базу данных вручную (см. раздел "Создание базы данных")

### Ошибка "permission denied"

Убедитесь, что пользователь имеет права на создание таблиц:

```sql
GRANT ALL PRIVILEGES ON DATABASE bazarlar_claude TO bazarlar_user;
```

## Сброс и пересоздание данных

Для полного пересоздания БД:

```bash
# 1. Удалить все таблицы (опционально, создайте скрипт drop_all.sql)
# 2. Запустить все миграции заново
python backend/migrations/run_migrations.py
```
