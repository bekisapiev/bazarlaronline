# Безопасность Bazarlar Online

Этот документ описывает реализованные меры безопасности в проекте Bazarlar Online.

## Реализованные защитные механизмы

### 1. Rate Limiting (Ограничение частоты запросов)

**Защита от:** Брутфорс атак, DDoS, автоматизированного сканирования

**Реализация:** `app/middleware/rate_limit.py`

**Лимиты:**
- Login endpoint: 5 попыток в минуту
- Registration endpoint: 3 регистрации в минуту
- OAuth endpoints: 10 запросов в минуту
- Refresh token: 20 запросов в минуту
- Другие endpoints: 100 запросов в минуту

**Блокировка:** При превышении лимита IP блокируется на 15 минут

**Заголовки:**
- `X-RateLimit-Remaining` - количество оставшихся попыток
- `Retry-After` - время до разблокировки

### 2. Security Headers

**Защита от:** XSS, Clickjacking, MIME-sniffing, Downgrade атак

**Реализация:** `app/middleware/security_headers.py`

**Заголовки:**
- `Content-Security-Policy` - ограничивает источники контента
- `Strict-Transport-Security` - принудительное HTTPS (production)
- `X-Content-Type-Options: nosniff` - защита от MIME-sniffing
- `X-Frame-Options: SAMEORIGIN` - защита от clickjacking
- `X-XSS-Protection: 1; mode=block` - XSS фильтр браузера
- `Referrer-Policy` - контроль передачи referrer
- `Permissions-Policy` - ограничение доступа к API браузера

### 3. Security Logger

**Защита от:** Все типы атак (мониторинг и оповещение)

**Реализация:** `app/middleware/security_logger.py`

**Логирует:**
- SQL Injection попытки
- XSS попытки
- Path Traversal попытки
- Command Injection попытки
- Неудачные попытки аутентификации (401)
- Запрещенные доступы (403)
- Превышение rate limit (429)
- Server errors (500+)
- Доступ к чувствительным endpoints

**Файл лога:** `security.log`

### 4. Error Handler

**Защита от:** Информационных утечек через сообщения об ошибках

**Реализация:** `app/middleware/error_handler.py`

**Особенности:**
- В production скрывает детали ошибок от пользователей
- Логирует полную информацию об ошибках для отладки
- Предотвращает утечку stack traces и внутренней информации

### 5. Input Validation & Sanitization

**Защита от:** SQL Injection, XSS, Path Traversal

**Реализация:** `app/core/validators.py`

**Валидаторы:**
- `validate_email()` - проверка email формата
- `validate_phone()` - проверка номера телефона
- `validate_password()` - проверка пароля (минимум 6 символов)
- `validate_uuid()` - проверка UUID формата
- `validate_integer()` - проверка целых чисел с диапазоном
- `sanitize_html()` - экранирование HTML символов
- `sanitize_string()` - комплексная санитизация строк
- `check_sql_injection()` - проверка на SQL injection паттерны
- `check_xss()` - проверка на XSS паттерны
- `check_path_traversal()` - проверка на path traversal

### 6. Password Security

**Защита от:** Компрометации паролей

**Реализация:** `app/core/security.py`

**Особенности:**
- Хеширование с bcrypt (высокая вычислительная сложность)
- Автоматическая генерация salt
- Минимальная длина пароля: 6 символов
- Максимальная длина пароля: 128 символов

### 7. JWT Token Security

**Защита от:** Подделки токенов, неавторизованного доступа

**Реализация:** `app/core/security.py`

**Особенности:**
- Разделение access и refresh токенов
- Проверка типа токена
- Проверка срока действия
- Проверка забаненных пользователей
- Использование HS256 алгоритма

### 8. SQL Injection Protection

**Защита от:** SQL Injection атак

**Реализация:** SQLAlchemy ORM + Validators

**Особенности:**
- Использование параметризованных запросов через SQLAlchemy
- Дополнительная валидация на уровне приложения
- Проверка всех пользовательских входных данных
- Никаких прямых SQL строк с интерполяцией переменных

### 9. CORS Configuration

**Защита от:** Cross-Origin атак

**Реализация:** `app/main.py`

**Настройки:**
- Явное указание разрешенных origins
- Разрешение credentials для авторизованных запросов
- Настройка разрешенных методов и заголовков

## Рекомендации по развертыванию

### Production Environment

1. **HTTPS обязателен:**
   ```bash
   # Используйте Let's Encrypt или другой SSL сертификат
   # Nginx должен перенаправлять HTTP -> HTTPS
   ```

2. **Переменные окружения:**
   ```bash
   ENVIRONMENT=production
   SECRET_KEY=<сгенерируйте сложный ключ>
   DATABASE_URL=<безопасное соединение с БД>
   ```

3. **Firewall настройки:**
   - Закройте прямой доступ к базе данных
   - Разрешите только необходимые порты (443, 80)
   - Используйте fail2ban для блокировки подозрительных IP

4. **Мониторинг:**
   - Регулярно проверяйте `security.log`
   - Настройте алерты для критических событий
   - Используйте систему мониторинга (Prometheus, Grafana)

5. **Обновления:**
   - Регулярно обновляйте зависимости
   - Следите за CVE для используемых библиотек
   - Применяйте security патчи

## Проверка безопасности

### Чеклист перед релизом:

- [ ] Изменен `SECRET_KEY` на уникальный
- [ ] `ENVIRONMENT=production`
- [ ] HTTPS настроен и работает
- [ ] База данных доступна только для приложения
- [ ] CORS origins настроены правильно
- [ ] Все пароли администраторов сложные
- [ ] Логи безопасности настроены
- [ ] Firewall настроен
- [ ] Бэкапы базы данных настроены

## Отчет о безопасности

Если вы обнаружили уязвимость, пожалуйста, сообщите об этом конфиденциально:
- Email: security@bazarlar.online
- Не публикуйте детали уязвимости публично

## Лицензия

Эти механизмы безопасности являются частью проекта Bazarlar Online.
